DROP TABLE IF EXISTS CommandTypes;
CREATE TABLE CommandTypes (
    pk INT PRIMARY KEY AUTO_INCREMENT,
    type TEXT
);

INSERT INTO CommandTypes (type) 
    VALUES 
    ('command'), 
    ('bashScript'), 
    ('pythonScript'); 

DROP TABLE IF EXISTS CommandClassifications;
CREATE TABLE CommandClassifications (
    pk INT PRIMARY KEY AUTO_INCREMENT,
    classification TEXT
);


INSERT INTO CommandClassifications
    (classification) VALUES('normalize'), ('access'), ('extract');

DROP TABLE IF EXISTS Commands;
CREATE TABLE Commands (
    pk INT PRIMARY KEY AUTO_INCREMENT,
    commandType INT,
    Foreign Key (commandType) references CommandTypes(pk),
    verificationCommand INT,
    Foreign Key (verificationCommand) references Commands(pk),
    command LONGTEXT,
    outputLocation TEXT,
    eventDetailCommand INT,
    Foreign Key (eventDetailCommand) references Commands(pk),
    description LONGTEXT
);

DROP TABLE IF EXISTS CommandRelationships;
CREATE TABLE CommandRelationships (
    pk INT PRIMARY KEY AUTO_INCREMENT,
    commandClassification INT,
    Foreign Key (commandClassification) references CommandClassifications(pk),
    command INT,
    Foreign Key (command) references Commands(pk),
    fileID INT,
    Foreign Key (fileID) references FileIDs(pk),
    GroupMember INT UNSIGNED DEFAULT 0,
    countAttempts INT UNSIGNED DEFAULT 0,
    countOK INT UNSIGNED DEFAULT 0,
    countNotOK INT UNSIGNED DEFAULT 0
);
-- UPDATE CommandRelationships SET countOK=countOK+1 Where pk=1234 --

DROP TABLE IF EXISTS FileIDs;
CREATE TABLE FileIDs (
    pk INT PRIMARY KEY AUTO_INCREMENT,
    description TEXT
);

DROP TABLE IF EXISTS FileIDsByExtension;
CREATE TABLE FileIDsByExtension (
    pk INT PRIMARY KEY AUTO_INCREMENT,
    Extension TEXT,
    FileIDs INT,
    Foreign Key (FileIDs) references Command(pk)
);

DROP TABLE IF EXISTS FileIDsByPronom;
CREATE TABLE FileIDsByPronom (
    pk INT PRIMARY KEY AUTO_INCREMENT,
    fileID TEXT,
    FileIDs INT,
    Foreign Key (FileIDs) references Command(pk)
);


INSERT INTO FileIDs
    (description) VALUES
    ('Normalize Defaults'), 
    ('Access Defaults'), 
    ('Extract Defaults'),
    ('7ZipCompatable'),
    ('unrar-nonfreeCompatable')
;

INSERT INTO Commands 
    (commandType, command, description) 
    SELECT pk,
    'test -e "%outputLocation%"',
    'Standard verification command'
    FROM CommandTypes WHERE type = 'command' ;

set @standardVerificationCommand = LAST_INSERT_ID();

-- Default copy command --
INSERT INTO Commands 
    (commandType, verificationCommand, command, outputLocation, description) 
    VALUES 
    ((SELECT pk FROM CommandTypes WHERE type = 'command'),
    (SELECT pk FROM  (Select * From Commands) AS temp WHERE description = 'Verifying file exists and is not size 0'),
    'cp -R "%inputFile%" "%outputDirectory%%prefix%%fileName%%postfix%.%fileExtension%"',
    '%outputDirectory%%prefix%%fileName%%postfix%.%fileExtension%',
    'Copying File.');
    --     'cp --version | grep cp',


-- Associate default access with copy --
INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'access'),
    (SELECT pk FROM Commands WHERE description = 'Copying File.'),
    (SELECT pk FROM FileIDs WHERE description = 'Access Defaults')
);

-- 7ZipCompatable

INSERT INTO Commands 
    (commandType, command, description) 
    -- VALUES SELECT pk FROM FileIDS WHERE description = 'Normalize Defaults'
    VALUES (
    (SELECT pk FROM CommandTypes WHERE type = 'bashScript'),
    ('echo program=\\"7z\\"\\; version=\\"`7z | grep Version`\\"'),
    ('Get event detail text for 7z extraction')
);

INSERT INTO Commands 
    (commandType, command, eventDetailCommand, outputLocation, description) 
    VALUES (
    (SELECT pk FROM CommandTypes WHERE type = 'command'),
    ('7z x -bd -o"%outputDirectory%" "%inputFile%"'),
    LAST_INSERT_ID(),
    '%outputDirectory%',
    ('Extracting 7zip compatable file.')
);

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'extract'),
    (SELECT pk FROM Commands WHERE description = 'Extracting 7zip compatable file.'),
    (SELECT pk FROM FileIDs WHERE description = '7ZipCompatable')
);
-- END 7ZipCompatable

INSERT INTO Commands 
    (commandType, command, description) 
    -- VALUES SELECT pk FROM FileIDS WHERE description = 'Normalize Defaults'
    VALUES (
    (SELECT pk FROM CommandTypes WHERE type = 'bashScript'),
    ('echo program=\\"unrar-nonfree\\"\\; version=\\"`unrar-nonfree | grep \'UNRAR\'`\\"'),
    ('Get event detail text for unrar extraction')
);

-- unrar-nonfreeCompatable
INSERT INTO Commands 
    (commandType, command, eventDetailCommand, outputLocation, description) 
    -- VALUES SELECT pk FROM FileIDS WHERE description = 'Normalize Defaults'
    VALUES (
    (SELECT pk FROM CommandTypes WHERE type = 'bashScript'),
    ('mkdir "%outputDirectory%" && unrar-nonfree x "%inputFile%" "%outputDirectory%"'),
    LAST_INSERT_ID(),
    '%outputDirectory%',
    ('Extracting unrar-nonfree compatable file.')
);
 


INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'extract'),
    (SELECT pk FROM Commands WHERE description = 'Extracting unrar-nonfree compatable file.'),
    (SELECT pk FROM FileIDs WHERE description = 'unrar-nonfreeCompatable')
);
-- END unrar-nonfreeCompatable


-- ADD Normalization Path for .JPG --
INSERT INTO FileIDs 
    (description)
    VALUES (
    'A .jpg file'
);
set @fileID = LAST_INSERT_ID();

INSERT INTO FileIDsByExtension 
    (Extension, FileIDs)
    VALUES (
    'jpg',
    @fileID
);


INSERT INTO Commands 
    (commandType, command, description) 
    -- VALUES SELECT pk FROM FileIDS WHERE description = 'Normalize Defaults'
    VALUES (
    (SELECT pk FROM CommandTypes WHERE type = 'bashScript'),
    ('echo program=\\"convert\\"\\; version=\\"`convert -version | grep Version:`\\"'),
    ('convert event detail')
);

set @convertToTifEventDetailCommandID = LAST_INSERT_ID();

INSERT INTO Commands 
    (commandType, command, outputLocation, eventDetailCommand, verificationCommand, description) 
    -- VALUES SELECT pk FROM FileIDS WHERE description = 'Normalize Defaults'
    VALUES (
    (SELECT pk FROM CommandTypes WHERE type = 'command'),
    ('convert "%fileFullName%" +compress "%outputDirectory%%prefix%%fileName%%postfix%.tif"'),
    '%outputDirectory%%prefix%%fileName%%postfix%.tif',
    @convertToTifEventDetailCommandID,
    @standardVerificationCommand,
    ('Transcoding to tif with convert')
);
set @convertToTifCommandID = LAST_INSERT_ID();

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'normalize'),
    @convertToTifCommandID,
    @fileID
);

-- End Of ADD Normalization Path for .JPG --

-- ADD Normalization Path for .GIF --
INSERT INTO FileIDs 
    (description)
    VALUES (
    'A .gif file'
);
set @fileID = LAST_INSERT_ID();

INSERT INTO FileIDsByExtension 
    (Extension, FileIDs)
    VALUES (
    'gif',
    @fileID
);


INSERT INTO Commands 
    (commandType, command, outputLocation, eventDetailCommand, verificationCommand, description) 
    -- VALUES SELECT pk FROM FileIDS WHERE description = 'Normalize Defaults'
    VALUES (
    (SELECT pk FROM CommandTypes WHERE type = 'command'),
    ('convert "%fileFullName%" "%outputDirectory%%prefix%%fileName%%postfix%.jpg"'),
    '%outputDirectory%%prefix%%fileName%%postfix%.jpg',
    @convertToTifEventDetailCommandID,
    @standardVerificationCommand,
    ('Transcoding to jpg with convert')
);
set @convertToJpgCommandID = LAST_INSERT_ID();

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'normalize'),
    @convertToTifCommandID,
    @fileID
);

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'access'),
    @convertToJpgCommandID,
    @fileID
);

-- End Of ADD Normalization Path for .GIF --

-- ADD Normalization Path for .TGA --
INSERT INTO FileIDs 
    (description)
    VALUES (
    'A .tga file'
);
set @fileID = LAST_INSERT_ID();

INSERT INTO FileIDsByExtension 
    (Extension, FileIDs)
    VALUES (
    'tga',
    @fileID
);

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'normalize'),
    @convertToTifCommandID,
    @fileID
);

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'access'),
    @convertToJpgCommandID,
    @fileID
);

-- End Of ADD Normalization Path for .TGA --

-- ADD Normalization Path for .BMP --
INSERT INTO FileIDs 
    (description)
    VALUES (
    'A .bmp file'
);
set @fileID = LAST_INSERT_ID();

INSERT INTO FileIDsByExtension 
    (Extension, FileIDs)
    VALUES (
    'bmp',
    @fileID
);

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'normalize'),
    @convertToTifCommandID,
    @fileID
);

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'access'),
    @convertToJpgCommandID,
    @fileID
);

-- End Of ADD Normalization Path for .BMP --


-- Commands for handling Video files --
INSERT INTO Commands 
    (commandType, command, description) 
    -- VALUES SELECT pk FROM FileIDS WHERE description = 'Normalize Defaults'
    VALUES (
    (SELECT pk FROM CommandTypes WHERE type = 'bashScript'),
    ('echo program=\\"ffmpeg\\"\\; version=\\"`ffmpeg 2>&1 | grep \"FFmpeg version\"`\\"'),
    ('Get event detail text for unrar extraction')
);

set @ffmpegEventDetailCommandID = LAST_INSERT_ID();

INSERT INTO Commands 
    (commandType, command, outputLocation, eventDetailCommand, verificationCommand, description) 
    -- VALUES SELECT pk FROM FileIDS WHERE description = 'Normalize Defaults'
    VALUES (
    (SELECT pk FROM CommandTypes WHERE type = 'command'),
    ('ffmpeg -i "%fileFullName%" -ar 44100 "%outputDirectory%%prefix%%fileName%%postfix%.mpg"'),
    '%outputDirectory%%prefix%%fileName%%postfix%.mpg',
    @ffmpegEventDetailCommandID,
    @standardVerificationCommand,
    ('Transcoding to mpg with ffmpeg')
);
set @ffmpegToMPGCommandID = LAST_INSERT_ID();

INSERT INTO Commands 
    (commandType, command, outputLocation, eventDetailCommand, verificationCommand, description) 
    -- VALUES SELECT pk FROM FileIDS WHERE description = 'Normalize Defaults'
    VALUES (
    (SELECT pk FROM CommandTypes WHERE type = 'command'),
    ('ffmpeg -i "%fileFullName%" -vcodec mpeg2video -qscale 1 -qmin 1 -intra -ar 48000 "%outputDirectory%%prefix%%fileName%%postfix%.mxf"'),
    '%outputDirectory%%prefix%%fileName%%postfix%.mxf',
    @ffmpegEventDetailCommandID,
    @standardVerificationCommand,
    ('Transcoding to mxf with ffmpeg')
);
set @ffmpegToMXFCommandID = LAST_INSERT_ID();

-- End of Commands for handling Video files --


-- ADD Normalization Path for .WMV --
INSERT INTO FileIDs 
    (description)
    VALUES (
    'A .wmv file'
);
set @fileID = LAST_INSERT_ID();

INSERT INTO FileIDsByExtension 
    (Extension, FileIDs)
    VALUES (
    'wmv',
    @fileID
);

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'normalize'),
    @ffmpegToMXFCommandID,
    @fileID
);

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'access'),
    @ffmpegToMPGCommandID,
    @fileID
);

-- End Of ADD Normalization Path for .WMV --

-- ADD Normalization Path for .SWF --
INSERT INTO FileIDs 
    (description)
    VALUES (
    'A .swf file'
);
set @fileID = LAST_INSERT_ID();

INSERT INTO FileIDsByExtension 
    (Extension, FileIDs)
    VALUES (
    'swf',
    @fileID
);

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'normalize'),
    @ffmpegToMXFCommandID,
    @fileID
);

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'access'),
    @ffmpegToMPGCommandID,
    @fileID
);

-- End Of ADD Normalization Path for .SWF --

-- ADD Normalization Path for .AVI --
INSERT INTO FileIDs 
    (description)
    VALUES (
    'A .avi file'
);
set @fileID = LAST_INSERT_ID();

INSERT INTO FileIDsByExtension 
    (Extension, FileIDs)
    VALUES (
    'avi',
    @fileID
);

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'normalize'),
    @ffmpegToMXFCommandID,
    @fileID
);

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'access'),
    @ffmpegToMPGCommandID,
    @fileID
);

-- End Of ADD Normalization Path for .AVI --

-- ADD Normalization Path for .MOV --
INSERT INTO FileIDs 
    (description)
    VALUES (
    'A .mov file'
);
set @fileID = LAST_INSERT_ID();

INSERT INTO FileIDsByExtension 
    (Extension, FileIDs)
    VALUES (
    'mov',
    @fileID
);

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'normalize'),
    @ffmpegToMXFCommandID,
    @fileID
);

INSERT INTO CommandRelationships 
    (commandClassification, command, fileID)
    VALUES (
    (SELECT pk FROM CommandClassifications WHERE classification = 'access'),
    @ffmpegToMPGCommandID,
    @fileID
);

-- End Of ADD Normalization Path for .MOV --
