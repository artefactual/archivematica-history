{% extends "layout.html" %}

{% block title %}Jobs+{% endblock %}
{% block h1 %}Jobs+{% endblock %}
{% block page_id %}jobsplus{% endblock %}

{% block js %}
  <script type="text/javascript">

    var client = {
      steps: 5,
      getJobsAwaitingApproval: function()
        {
          if (client.step < client.steps - 1)
          {
            client.step++;

            return;
          }
          // First time this function is called
          else
          {
            client.step = 0;
          }

          window.clearInterval(client.intervalID);

          $.ajax({
            cache: false,
            complete: function()
              {
                // client.intervalID = window.setInterval(client.getJobsAwaitingApproval, 1000);
              },
            dataType: 'xml',
            error: function(xhr, text)
              {
                $('#result').html(text);
              },
            type: 'GET',
            success: function(data)
              {
                $jobs = $(data).find('Job');

                $jobs.each(function (index)
                  {
                    var $this = $(this);
                    var uuid = $this.children('UUID').text();
                    var $tr = $('tr[uuid=' + uuid + ']');

                    $tr
                      .css('background-color', '#ffdda7')
                      .insertBefore('table tr:eq(1)')
                      .find('p.approval_description').show().children('span').html($this.children('descriptionForApproval').text());
                  
                    $tr.find('p.actions a').show().end().find('a.btn_approve_job').removeClass('hidden').click(function (event)
                      {
                        event.preventDefault();

                        $.ajax({
                          data: { uuid: uuid },
                          type: 'POST',
                          success: function(data)
                            {
                              if (0 < data.length)
                              {
                                this.replaceWith('<span>Approved!</span>');
                              }
                            },
                          url: '/mcp/approve-job/'
                        });
                      });
                  });
              },
            url: '/mcp/jobs-awaiting-approval/'
          });
        }
    };

    $(document).ready(function()
      {
        client.getJobsAwaitingApproval();

        $('a.btn_show_tasks').live('click', function (event)
          {
            event.preventDefault();
            
            var $this = $(this);
            
            if ($this.text() == 'Show tasks')
            {
              $this.text('Loading');

              $.ajax({
                data: { jobuuid: $this.closest('tr').attr('uuid') },
                type: 'GET',
                success: function(data)
                  {
                    var taskrows = $(data).find('table');

                    var $box = $('<div class="tasks" />')
                      .append(taskrows)
                      .find('table').prepend('<caption>Tasks</caption>').end();

                    $this.closest('tr').find('div.data').html($box.hide());
                    $box.slideDown('fast', function()
                      {
                        $this.text('Hide tasks');
                      });
                  },
                url: '/tasks/'
              });
            }
            else
            {
              $this.text('Show tasks');
              
              $this.closest('tr').find('div.tasks').slideUp('fast');
            }
          });
      });

  </script>
  <style type="text/css">
    .odd { background-color: #f2f2f2; }
     p { margin: 0px; }
     p.approval_description, .hidden { display: none; }
     div.tasks { margin-top: 10px; }
     p.actions a { margin-left: 4px; }
     .hide_in_ajax { display: none; }
  </style>
{% endblock %}

{% block content %}

  <table border="1" width="100%" style="margin: 20px auto 0 auto;">
    <thead>
      <tr>
        <th>Job</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for item in objects %}
        <tr class="{% cycle 'odd' 'even' %}" uuid="{{ item.jobuuid }}">
          <td>
            <p><strong>UUID:</strong> {{ item.jobuuid }}</p>
            <p class="approval_description"><strong>Description for approval:</strong>&nbsp;<span class="value" /></p>
            <p<a class="btn_show_tasks" href="#">Show tasks</a></p>
            <div class="data"></div>
          </td>
          <td width="360px">
            {{ item.currentstep }}
            <p class="actions">
              <a class="hidden btn_open_dir" target="_blank" title="{{ item.diretory }}" href="file://{{ item.directory }}">Open directory</a>
              <a class="hidden btn_approve_job" href="#">Approve</a>
            </p>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

{% endblock %}
