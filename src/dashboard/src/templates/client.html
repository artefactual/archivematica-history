{% extends "layout.html" %}

{% block title %}XML-RPC client{% endblock %}
{% block h1 %}XML-RPC client{% endblock %}
{% block page_id %}client{% endblock %}

{% block js %}
  <script type="text/javascript">

    var client = {
      steps: 5,
      getLoadingMessage: function()
        {
          return $('<p>Next try in ' + (client.steps - (client.step ? client.step : 0)) + 's. <a href="#">Reload now</a>.</p>')
            .find('a').click(function (event)
              {
                event.preventDefault();
                client.getJobsAwaitingApproval(true);
              }).end();
        },
      getJobsAwaitingApproval: function(restart)
        {
          if (!restart && client.step < client.steps - 1)
          {
            client.step++;

            $('#loading').html(client.getLoadingMessage());

            return;
          }
          // First time this function is called
          else
          {
            client.step = 0;
          }

          $('#loading').html(client.getLoadingMessage());

          window.clearInterval(client.intervalID);

          $.ajax({
            cache: false,
            complete: function()
              {
                client.intervalID = window.setInterval(client.getJobsAwaitingApproval, 1000);
              },
            error: function()
              {
                $('#result').html("Error.");
              },
            type: 'GET',
            success: function(data)
              {
                var now = new Date();

                // $('#last').text('Time: ' + now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds());
                $('#result').text(data);
              },
            url: '/mcp/jobs-awaiting-approval/'
          });
        }
    };

    $(document).ready(function()
      {
        $('#content').html(
          '<div id="result">&nbsp;</div>' +
          '<div id="loading">&nbsp;</div>');

        client.getJobsAwaitingApproval();

      });

  </script>
{% endblock %}

{% block content %}
  <div>
    <p>This page requires a javascript capable browser.</p>
  </div>
{% endblock %}
